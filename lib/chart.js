// Generated by CoffeeScript 1.8.0
var Chart, Follower, React, XAxis, YAxis, d3, flatten, helpers, _ref;

React = require('react');

d3 = require('d3');

_ref = require('./axes'), XAxis = _ref.XAxis, YAxis = _ref.YAxis;

Follower = require('./follower');

helpers = require('./helpers');

flatten = function(ls) {
  var flat, i, l, _i, _j, _len, _len1;
  flat = [];
  for (_i = 0, _len = ls.length; _i < _len; _i++) {
    l = ls[_i];
    if (Array.isArray(l)) {
      for (_j = 0, _len1 = l.length; _j < _len1; _j++) {
        i = l[_j];
        flat.push(i);
      }
    }
  }
  return flat;
};

module.exports = Chart = {
  getDefaultProps: function() {
    return {
      width: 100,
      height: 100,
      padding: 0,
      axis_size: 20,
      color: d3.scaleOrdinal(d3.schemeCategory10)
    };
  },
  componentWillMount: function() {
    return this.createAxes(this.props);
  },
  componentWillReceiveProps: function(next_props) {
    return this.createAxes(next_props);
  },
  shouldComponentUpdate: function(next_props, next_state) {
    var _ref1;
    if (Array.isArray((_ref1 = next_props.data) != null ? _ref1[0] : void 0)) {
      return true;
    }
    if (next_props.data.length !== this.props.data.length) {
      return true;
    } else if ((next_props.width !== this.props.width) || (next_props.height !== this.props.height)) {
      return true;
    } else if ((next_props.y !== this.props.y) || (next_props.x !== this.props.x)) {
      return true;
    } else {
      return false;
    }
  },
  createAxes: function(props) {
    var data, flat_data, height, i, padding, width, x, x_axis, x_extent, y, y_axis, y_extent, _data, _i, _j, _len, _len1;
    x = props.x, y = props.y, width = props.width, height = props.height, data = props.data, padding = props.padding, x_axis = props.x_axis, y_axis = props.y_axis;
    padding = helpers.transformPadding(padding);
    if (this.multi) {
      flat_data = [];
      for (_i = 0, _len = data.length; _i < _len; _i++) {
        _data = data[_i];
        for (_j = 0, _len1 = _data.length; _j < _len1; _j++) {
          i = _data[_j];
          flat_data.push(i);
        }
      }
    } else {
      flat_data = data;
    }
    if (x == null) {
      x_extent = (x_axis != null ? x_axis.domain : void 0) || (typeof this.xDomain === "function" ? this.xDomain() : void 0) || d3.extent(flat_data, function(d) {
        return d.x;
      });
      x = d3.scaleLinear().range([padding.left, width - padding.right]).domain(x_extent);
    }
    if (y == null) {
      y_extent = (y_axis != null ? y_axis.domain : void 0) || d3.extent(flat_data, function(d) {
        return d.y;
      });
      if (y_axis != null ? y_axis.zero : void 0) {
        y_extent = [
          0, d3.max(flat_data, function(d) {
            return d.y;
          })
        ];
      }
      y = d3.scaleLinear().range([height - padding.bottom, padding.top]).domain(y_extent);
    }
    return this.setState({
      x: x,
      y: y
    });
  },
  render: function() {
    var axis_size, color, data, follower, height, padding, title, width, x_axis, y_axis, _ref1;
    _ref1 = this.props, width = _ref1.width, height = _ref1.height, data = _ref1.data, title = _ref1.title, color = _ref1.color, padding = _ref1.padding, axis_size = _ref1.axis_size, follower = _ref1.follower, x_axis = _ref1.x_axis, y_axis = _ref1.y_axis;
    padding = helpers.transformPadding(padding);
    x_axis || (x_axis = {});
    y_axis || (y_axis = {});
    return React.createElement("div", {
      "className": 'chart',
      "style": {
        position: 'relative',
        width: width,
        height: height
      }
    }, (title ? React.createElement("div", {
      "className": 'title'
    }, title) : void 0), this.renderChart(), (!x_axis.hidden ? React.createElement(XAxis, React.__spread({
      "x": this.state.x,
      "width": width,
      "height": axis_size,
      "position": 'bottom'
    }, x_axis)) : void 0), (!y_axis.hidden ? React.createElement(YAxis, React.__spread({
      "y": this.state.y,
      "height": height,
      "width": axis_size,
      "position": 'left'
    }, y_axis)) : void 0), (follower ? (typeof follower === 'boolean' ? follower = {} : void 0, React.createElement(Follower, React.__spread({
      "width": width,
      "height": height,
      "data": data,
      "color": color,
      "x": this.state.x,
      "y": this.state.y,
      "multi": this.multi
    }, follower))) : void 0));
  }
};
