// Generated by CoffeeScript 1.10.0
var Chart, React, XAxis, YAxis, d3, flatten, helpers, ref,
  extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
  hasProp = {}.hasOwnProperty;

React = require('preact');

d3 = require('d3');

ref = require('./axes'), XAxis = ref.XAxis, YAxis = ref.YAxis;

helpers = require('./helpers');

flatten = function(ls) {
  var flat, i, j, k, l, len, len1;
  flat = [];
  for (j = 0, len = ls.length; j < len; j++) {
    l = ls[j];
    if (Array.isArray(l)) {
      for (k = 0, len1 = l.length; k < len1; k++) {
        i = l[k];
        flat.push(i);
      }
    }
  }
  return flat;
};

module.exports = Chart = (function(superClass) {
  extend(Chart, superClass);

  function Chart() {
    return Chart.__super__.constructor.apply(this, arguments);
  }

  Chart.prototype.getDefaultProps = function() {
    return {
      width: 100,
      height: 100,
      padding: 0,
      axis_size: 20,
      color: d3.scaleOrdinal(d3.schemeCategory10)
    };
  };

  Chart.prototype.componentWillMount = function() {
    return this.createAxes(this.props);
  };

  Chart.prototype.componentWillReceiveProps = function(next_props) {
    return this.createAxes(next_props);
  };

  Chart.prototype.shouldComponentUpdate = function(next_props, next_state) {
    var ref1;
    if (Array.isArray((ref1 = next_props.data) != null ? ref1[0] : void 0)) {
      return true;
    }
    if (next_props.data.length !== this.props.data.length) {
      return true;
    } else if ((next_props.width !== this.props.width) || (next_props.height !== this.props.height)) {
      return true;
    } else if ((next_props.y !== this.props.y) || (next_props.x !== this.props.x)) {
      return true;
    } else if (this.props.checkForUpdate) {
      return this.props.checkForUpdate(this.props, next_props, next_state);
    } else {
      return false;
    }
  };

  Chart.prototype.createAxes = function(props) {
    var _data, data, flat_data, height, i, j, k, len, len1, padding, ref1, width, x, x_axis, x_extent, y, y_axis, y_extent;
    x = props.x, y = props.y, width = props.width, height = props.height, data = props.data, padding = props.padding, x_axis = props.x_axis, y_axis = props.y_axis;
    padding = helpers.transformPadding(padding);
    if (this.multi) {
      flat_data = [];
      for (j = 0, len = data.length; j < len; j++) {
        _data = data[j];
        for (k = 0, len1 = _data.length; k < len1; k++) {
          i = _data[k];
          flat_data.push(i);
        }
      }
    } else {
      flat_data = data;
    }
    if (x == null) {
      x_extent = (x_axis != null ? x_axis.domain : void 0) || (typeof this.xDomain === "function" ? this.xDomain() : void 0) || d3.extent(flat_data, function(d) {
        return d.x;
      });
      x = d3.scaleLinear().range([padding.left, width - padding.right]).domain(x_extent);
    }
    if (y == null) {
      y_extent = (y_axis != null ? y_axis.domain : void 0) || d3.extent(flat_data, function(d) {
        return d.y;
      });
      if (y_axis != null ? y_axis.zero : void 0) {
        y_extent = [
          0, (y_axis != null ? (ref1 = y_axis.domain) != null ? ref1[1] : void 0 : void 0) || d3.max(flat_data, function(d) {
            return d.y;
          })
        ];
      }
      y = d3.scaleLinear().range([height - padding.bottom, padding.top]).domain(y_extent);
    }
    return this.setState({
      x: x,
      y: y
    });
  };

  Chart.prototype.calculateHeight = function() {
    if (this.chartHeight != null) {
      return this.chartHeight();
    } else {
      return this.props.height;
    }
  };

  Chart.prototype.render = function() {
    var axis_size, color, container_height, data, follower, height, padding, ref1, title, width, x_axis, y_axis;
    ref1 = this.props, width = ref1.width, height = ref1.height, data = ref1.data, title = ref1.title, color = ref1.color, padding = ref1.padding, axis_size = ref1.axis_size, follower = ref1.follower, x_axis = ref1.x_axis, y_axis = ref1.y_axis;
    padding = helpers.transformPadding(padding);
    x_axis || (x_axis = {});
    y_axis || (y_axis = {});
    axis_size || (axis_size = 1);
    container_height = this.calculateHeight();
    return React.createElement("div", {
      "className": 'chart',
      "style": {
        position: 'relative',
        width: width,
        height: container_height
      },
      "height": container_height,
      "width": width
    }, (title ? React.createElement("div", {
      "className": 'title'
    }, title) : void 0), this.renderChart(), (!x_axis.hidden ? React.createElement(XAxis, Object.assign({
      "x": this.state.x,
      "axis_size": axis_size,
      "width": width,
      "height": this.props.height,
      "position": 'bottom'
    }, x_axis)) : void 0), (!y_axis.hidden ? React.createElement(YAxis, Object.assign({
      "y": this.state.y,
      "axis_size": axis_size,
      "height": this.props.height,
      "width": axis_size,
      "position": 'left'
    }, y_axis)) : void 0));
  };

  return Chart;

})(React.Component);
